"""
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–æ—Ç–∞ –ø–æ–≥–æ–¥—ã
"""
import os
import json
import time
import logging
from datetime import datetime, timedelta
from typing import Optional, Dict, Any, Callable

logger = logging.getLogger(__name__)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –æ–ø–∏—Å–∞–Ω–∏–π –ø–æ–≥–æ–¥—ã –Ω–∞ —Ä—É—Å—Å–∫–∏–π
WEATHER_TRANSLATIONS = {
    "clear sky": "—è—Å–Ω–æ–µ –Ω–µ–±–æ",
    "few clouds": "–Ω–µ–±–æ–ª—å—à–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å",
    "scattered clouds": "–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å",
    "broken clouds": "–æ–±–ª–∞—á–Ω–æ —Å –ø—Ä–æ—è—Å–Ω–µ–Ω–∏—è–º–∏",
    "shower rain": "–ª–∏–≤–µ–Ω—å",
    "rain": "–¥–æ–∂–¥—å",
    "thunderstorm": "–≥—Ä–æ–∑–∞",
    "snow": "—Å–Ω–µ–≥",
    "mist": "—Ç—É–º–∞–Ω",
    "light rain": "–ª–µ–≥–∫–∏–π –¥–æ–∂–¥—å",
    "moderate rain": "—É–º–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å",
    "heavy rain": "—Å–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
    "light snow": "–ª–µ–≥–∫–∏–π —Å–Ω–µ–≥",
    "moderate snow": "—É–º–µ—Ä–µ–Ω–Ω—ã–π —Å–Ω–µ–≥",
    "heavy snow": "—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥",
    "sleet": "–º–æ–∫—Ä—ã–π —Å–Ω–µ–≥",
    "freezing rain": "–ª–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å",
    "overcast clouds": "–ø–∞—Å–º—É—Ä–Ω–æ",
    "light intensity drizzle": "–ª–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å",
    "drizzle": "–º–æ—Ä–æ—Å—å",
    "heavy intensity drizzle": "—Å–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å",
    "light intensity shower rain": "–ª–µ–≥–∫–∏–π –ª–∏–≤–µ–Ω—å",
    "heavy intensity shower rain": "—Å–∏–ª—å–Ω—ã–π –ª–∏–≤–µ–Ω—å",
    "ragged shower rain": "–ø—Ä–µ—Ä—ã–≤–∏—Å—Ç—ã–π –ª–∏–≤–µ–Ω—å",
    "light snow": "–ª–µ–≥–∫–∏–π —Å–Ω–µ–≥",
    "heavy intensity snow": "—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥",
    "sleet": "–º–æ–∫—Ä—ã–π —Å–Ω–µ–≥",
    "light shower sleet": "–ª–µ–≥–∫–∏–π –º–æ–∫—Ä—ã–π —Å–Ω–µ–≥",
    "shower sleet": "–º–æ–∫—Ä—ã–π —Å–Ω–µ–≥",
    "light rain and snow": "–ª–µ–≥–∫–∏–π –¥–æ–∂–¥—å —Å–æ —Å–Ω–µ–≥–æ–º",
    "rain and snow": "–¥–æ–∂–¥—å —Å–æ —Å–Ω–µ–≥–æ–º",
    "light shower snow": "–ª–µ–≥–∫–∏–π —Å–Ω–µ–≥–æ–ø–∞–¥",
    "shower snow": "—Å–Ω–µ–≥–æ–ø–∞–¥",
    "heavy shower snow": "—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥",
    "smoke": "–¥—ã–º",
    "haze": "–¥—ã–º–∫–∞",
    "sand/ dust whirls": "–ø–µ—Å—á–∞–Ω—ã–µ/–ø—ã–ª—å–Ω—ã–µ –≤–∏—Ö—Ä–∏",
    "fog": "—Ç—É–º–∞–Ω",
    "sand": "–ø–µ—Å–æ–∫",
    "dust": "–ø—ã–ª—å",
    "volcanic ash": "–≤—É–ª–∫–∞–Ω–∏—á–µ—Å–∫–∏–π –ø–µ–ø–µ–ª",
    "squalls": "—à–∫–≤–∞–ª—ã",
    "tornado": "—Ç–æ—Ä–Ω–∞–¥–æ",
}

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–∑–¥—É—Ö–∞
POLLUTION_STATUS_TRANSLATIONS = {
    "Good": "–•–æ—Ä–æ—à–æ",
    "Fair": "–ü—Ä–∏–µ–º–ª–µ–º–æ",
    "Moderate": "–ü–ª–æ—Ö–æ",
    "Poor": "–û—á–µ–Ω—å –ø–ª–æ—Ö–æ",
    "Very Poor": "–ß—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ –ø–ª–æ—Ö–æ",
}

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∫–æ–¥–æ–≤ —Å—Ç—Ä–∞–Ω –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
COUNTRY_TRANSLATIONS = {
    "RU": "–†–æ—Å—Å–∏—è", "US": "–°–®–ê", "GB": "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", "DE": "–ì–µ—Ä–º–∞–Ω–∏—è",
    "FR": "–§—Ä–∞–Ω—Ü–∏—è", "IT": "–ò—Ç–∞–ª–∏—è", "ES": "–ò—Å–ø–∞–Ω–∏—è", "PL": "–ü–æ–ª—å—à–∞",
    "UA": "–£–∫—Ä–∞–∏–Ω–∞", "BY": "–ë–µ–ª–∞—Ä—É—Å—å", "KZ": "–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω", "CN": "–ö–∏—Ç–∞–π",
    "JP": "–Ø–ø–æ–Ω–∏—è", "KR": "–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è", "IN": "–ò–Ω–¥–∏—è", "TH": "–¢–∞–∏–ª–∞–Ω–¥",
    "TR": "–¢—É—Ä—Ü–∏—è", "GR": "–ì—Ä–µ—Ü–∏—è", "EG": "–ï–≥–∏–ø–µ—Ç", "AE": "–û–ê–≠",
    "SA": "–°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è", "BR": "–ë—Ä–∞–∑–∏–ª–∏—è", "AR": "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞",
    "MX": "–ú–µ–∫—Å–∏–∫–∞", "CA": "–ö–∞–Ω–∞–¥–∞", "AU": "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "NZ": "–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è",
    "NL": "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã", "BE": "–ë–µ–ª—å–≥–∏—è", "CH": "–®–≤–µ–π—Ü–∞—Ä–∏—è", "AT": "–ê–≤—Å—Ç—Ä–∏—è",
    "SE": "–®–≤–µ—Ü–∏—è", "NO": "–ù–æ—Ä–≤–µ–≥–∏—è", "DK": "–î–∞–Ω–∏—è", "FI": "–§–∏–Ω–ª—è–Ω–¥–∏—è",
    "PT": "–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è", "CZ": "–ß–µ—Ö–∏—è", "HU": "–í–µ–Ω–≥—Ä–∏—è", "RO": "–†—É–º—ã–Ω–∏—è",
    "BG": "–ë–æ–ª–≥–∞—Ä–∏—è", "HR": "–•–æ—Ä–≤–∞—Ç–∏—è", "RS": "–°–µ—Ä–±–∏—è", "SI": "–°–ª–æ–≤–µ–Ω–∏—è",
    "SK": "–°–ª–æ–≤–∞–∫–∏—è", "LT": "–õ–∏—Ç–≤–∞", "LV": "–õ–∞—Ç–≤–∏—è", "EE": "–≠—Å—Ç–æ–Ω–∏—è",
    "IE": "–ò—Ä–ª–∞–Ω–¥–∏—è", "IS": "–ò—Å–ª–∞–Ω–¥–∏—è", "MT": "–ú–∞–ª—å—Ç–∞", "CY": "–ö–∏–ø—Ä",
    "IL": "–ò–∑—Ä–∞–∏–ª—å", "JO": "–ò–æ—Ä–¥–∞–Ω–∏—è", "LB": "–õ–∏–≤–∞–Ω", "IQ": "–ò—Ä–∞–∫",
    "IR": "–ò—Ä–∞–Ω", "PK": "–ü–∞–∫–∏—Å—Ç–∞–Ω", "BD": "–ë–∞–Ω–≥–ª–∞–¥–µ—à", "VN": "–í—å–µ—Ç–Ω–∞–º",
    "PH": "–§–∏–ª–∏–ø–ø–∏–Ω—ã", "ID": "–ò–Ω–¥–æ–Ω–µ–∑–∏—è", "MY": "–ú–∞–ª–∞–π–∑–∏—è", "SG": "–°–∏–Ω–≥–∞–ø—É—Ä",
    "HK": "–ì–æ–Ω–∫–æ–Ω–≥", "TW": "–¢–∞–π–≤–∞–Ω—å", "MN": "–ú–æ–Ω–≥–æ–ª–∏—è", "AF": "–ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω",
    "NP": "–ù–µ–ø–∞–ª", "LK": "–®—Ä–∏-–õ–∞–Ω–∫–∞", "MM": "–ú—å—è–Ω–º–∞", "KH": "–ö–∞–º–±–æ–¥–∂–∞",
    "LA": "–õ–∞–æ—Å", "BN": "–ë—Ä—É–Ω–µ–π", "TL": "–í–æ—Å—Ç–æ—á–Ω—ã–π –¢–∏–º–æ—Ä", "MV": "–ú–∞–ª—å–¥–∏–≤—ã",
    "ZA": "–Æ–ê–†", "KE": "–ö–µ–Ω–∏—è", "NG": "–ù–∏–≥–µ—Ä–∏—è",
    "MA": "–ú–∞—Ä–æ–∫–∫–æ", "DZ": "–ê–ª–∂–∏—Ä", "TN": "–¢—É–Ω–∏—Å", "LY": "–õ–∏–≤–∏—è",
    "SD": "–°—É–¥–∞–Ω", "ET": "–≠—Ñ–∏–æ–ø–∏—è", "TZ": "–¢–∞–Ω–∑–∞–Ω–∏—è", "UG": "–£–≥–∞–Ω–¥–∞",
    "RW": "–†—É–∞–Ω–¥–∞", "GH": "–ì–∞–Ω–∞", "SN": "–°–µ–Ω–µ–≥–∞–ª", "CI": "–ö–æ—Ç-–¥'–ò–≤—É–∞—Ä",
    "CM": "–ö–∞–º–µ—Ä—É–Ω", "AO": "–ê–Ω–≥–æ–ª–∞", "MZ": "–ú–æ–∑–∞–º–±–∏–∫", "ZM": "–ó–∞–º–±–∏—è",
    "ZW": "–ó–∏–º–±–∞–±–≤–µ", "BW": "–ë–æ—Ç—Å–≤–∞–Ω–∞", "NA": "–ù–∞–º–∏–±–∏—è", "MG": "–ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä",
    "MU": "–ú–∞–≤—Ä–∏–∫–∏–π", "SC": "–°–µ–π—à–µ–ª—ã", "CL": "–ß–∏–ª–∏", "PE": "–ü–µ—Ä—É",
    "CO": "–ö–æ–ª—É–º–±–∏—è", "VE": "–í–µ–Ω–µ—Å—É—ç–ª–∞", "EC": "–≠–∫–≤–∞–¥–æ—Ä", "BO": "–ë–æ–ª–∏–≤–∏—è",
    "PY": "–ü–∞—Ä–∞–≥–≤–∞–π", "UY": "–£—Ä—É–≥–≤–∞–π", "GY": "–ì–∞–π–∞–Ω–∞", "SR": "–°—É—Ä–∏–Ω–∞–º",
    "GF": "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –ì–≤–∏–∞–Ω–∞", "FK": "–§–æ–ª–∫–ª–µ–Ω–¥—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞", "GS": "–Æ–∂–Ω–∞—è –ì–µ–æ—Ä–≥–∏—è",
    "CU": "–ö—É–±–∞", "JM": "–Ø–º–∞–π–∫–∞", "HT": "–ì–∞–∏—Ç–∏", "DO": "–î–æ–º–∏–Ω–∏–∫–∞–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞",
    "PR": "–ü—É—ç—Ä—Ç–æ-–†–∏–∫–æ", "TT": "–¢—Ä–∏–Ω–∏–¥–∞–¥ –∏ –¢–æ–±–∞–≥–æ", "BB": "–ë–∞—Ä–±–∞–¥–æ—Å",
    "BS": "–ë–∞–≥–∞–º—ã", "BZ": "–ë–µ–ª–∏–∑", "CR": "–ö–æ—Å—Ç–∞-–†–∏–∫–∞", "PA": "–ü–∞–Ω–∞–º–∞",
    "NI": "–ù–∏–∫–∞—Ä–∞–≥—É–∞", "HN": "–ì–æ–Ω–¥—É—Ä–∞—Å", "SV": "–°–∞–ª—å–≤–∞–¥–æ—Ä", "GT": "–ì–≤–∞—Ç–µ–º–∞–ª–∞",
    "FJ": "–§–∏–¥–∂–∏", "PG": "–ü–∞–ø—É–∞-–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è", "NC": "–ù–æ–≤–∞—è –ö–∞–ª–µ–¥–æ–Ω–∏—è",
    "PF": "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è –ü–æ–ª–∏–Ω–µ–∑–∏—è", "WS": "–°–∞–º–æ–∞", "TO": "–¢–æ–Ω–≥–∞", "VU": "–í–∞–Ω—É–∞—Ç—É",
    "SB": "–°–æ–ª–æ–º–æ–Ω–æ–≤—ã –û—Å—Ç—Ä–æ–≤–∞", "KI": "–ö–∏—Ä–∏–±–∞—Ç–∏", "TV": "–¢—É–≤–∞–ª—É", "NR": "–ù–∞—É—Ä—É",
    "PW": "–ü–∞–ª–∞—É", "FM": "–ú–∏–∫—Ä–æ–Ω–µ–∑–∏—è", "MH": "–ú–∞—Ä—à–∞–ª–ª–æ–≤—ã –û—Å—Ç—Ä–æ–≤–∞", "AS": "–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–æ–µ –°–∞–º–æ–∞",
    "GU": "–ì—É–∞–º", "MP": "–°–µ–≤–µ—Ä–Ω—ã–µ –ú–∞—Ä–∏–∞–Ω—Å–∫–∏–µ –æ—Å—Ç—Ä–æ–≤–∞", "VI": "–í–∏—Ä–≥–∏–Ω—Å–∫–∏–µ –û—Å—Ç—Ä–æ–≤–∞ (–°–®–ê)",
    "VG": "–í–∏—Ä–≥–∏–Ω—Å–∫–∏–µ –û—Å—Ç—Ä–æ–≤–∞ (–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è)", "KY": "–ö–∞–π–º–∞–Ω–æ–≤—ã –æ—Å—Ç—Ä–æ–≤–∞", "BM": "–ë–µ—Ä–º—É–¥—ã",
    "TC": "–¢–µ—Ä–∫—Å –∏ –ö–∞–π–∫–æ—Å", "MS": "–ú–æ–Ω—Ç—Å–µ—Ä—Ä–∞—Ç", "AI": "–ê–Ω–≥–∏–ª—å—è", "AG": "–ê–Ω—Ç–∏–≥—É–∞ –∏ –ë–∞—Ä–±—É–¥–∞",
    "DM": "–î–æ–º–∏–Ω–∏–∫–∞", "GD": "–ì—Ä–µ–Ω–∞–¥–∞", "LC": "–°–µ–Ω—Ç-–õ—é—Å–∏—è", "VC": "–°–µ–Ω—Ç-–í–∏–Ω—Å–µ–Ω—Ç –∏ –ì—Ä–µ–Ω–∞–¥–∏–Ω—ã",
    "KN": "–°–µ–Ω—Ç-–ö–∏—Ç—Å –∏ –ù–µ–≤–∏—Å", "AD": "–ê–Ω–¥–æ—Ä—Ä–∞", "MC": "–ú–æ–Ω–∞–∫–æ", "SM": "–°–∞–Ω-–ú–∞—Ä–∏–Ω–æ",
    "VA": "–í–∞—Ç–∏–∫–∞–Ω", "LI": "–õ–∏—Ö—Ç–µ–Ω—à—Ç–µ–π–Ω", "LU": "–õ—é–∫—Å–µ–º–±—É—Ä–≥", "ME": "–ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è",
    "AL": "–ê–ª–±–∞–Ω–∏—è", "MK": "–°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è", "BA": "–ë–æ—Å–Ω–∏—è –∏ –ì–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞",
    "XK": "–ö–æ—Å–æ–≤–æ", "MD": "–ú–æ–ª–¥–æ–≤–∞", "GE": "–ì—Ä—É–∑–∏—è", "AM": "–ê—Ä–º–µ–Ω–∏—è",
    "AZ": "–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω", "TM": "–¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω", "UZ": "–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω", "TJ": "–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω",
    "KG": "–ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω", "KP": "–ö–ù–î–†", "MO": "–ú–∞–∫–∞–æ",
}


def translate_country_code(country_code: str) -> str:
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
    
    Args:
        country_code: –î–≤—É—Ö–±—É–∫–≤–µ–Ω–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "US", "RU")
    
    Returns:
        –ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    """
    if not country_code:
        return ""
    
    country_code = country_code.upper()
    return COUNTRY_TRANSLATIONS.get(country_code, country_code)


def convert_pressure_hpa_to_mmhg(pressure_hpa: float) -> float:
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–≤–ª–µ–Ω–∏–µ –∏–∑ hPa –≤ –º–º.—Ä—Ç.—Å—Ç.
    
    Args:
        pressure_hpa: –î–∞–≤–ª–µ–Ω–∏–µ –≤ –≥–µ–∫—Ç–æ–ø–∞—Å–∫–∞–ª—è—Ö
    
    Returns:
        –î–∞–≤–ª–µ–Ω–∏–µ –≤ –º–∏–ª–ª–∏–º–µ—Ç—Ä–∞—Ö —Ä—Ç—É—Ç–Ω–æ–≥–æ —Å—Ç–æ–ª–±–∞
    """
    if pressure_hpa == 'N/A' or pressure_hpa is None:
        return 'N/A'
    
    try:
        return round(pressure_hpa * 0.750062, 1)
    except (TypeError, ValueError):
        return 'N/A'


def ensure_cache_dir():
    """–°–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é .cache –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    cache_dir = ".cache"
    if not os.path.exists(cache_dir):
        os.makedirs(cache_dir)
    return cache_dir


def get_cache_path(key: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫—ç—à–∞"""
    cache_dir = ensure_cache_dir()
    # –ó–∞–º–µ–Ω—è–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    safe_key = key.replace("/", "_").replace("\\", "_").replace(":", "_")
    return os.path.join(cache_dir, f"{safe_key}.json")


def load_cache(key: str) -> Optional[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç
    
    Args:
        key: –ö–ª—é—á –∫—ç—à–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "55.7558_37.6173_weather")
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None –µ—Å–ª–∏ –∫—ç—à —É—Å—Ç–∞—Ä–µ–ª/–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    """
    cache_path = get_cache_path(key)
    
    if not os.path.exists(cache_path):
        return None
    
    try:
        with open(cache_path, 'r', encoding='utf-8') as f:
            cache_data = json.load(f)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—ç—à–∞
        cached_time = datetime.fromisoformat(cache_data.get('timestamp', ''))
        current_time = datetime.now()
        
        # –ö—ç—à –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç
        if current_time - cached_time > timedelta(minutes=10):
            logger.info(f"–ö—ç—à –¥–ª—è {key} —É—Å—Ç–∞—Ä–µ–ª, —É–¥–∞–ª—è–µ–º")
            os.remove(cache_path)
            return None
        
        logger.info(f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à –¥–ª—è {key}")
        return cache_data.get('data')
    
    except (json.JSONDecodeError, ValueError, KeyError) as e:
        logger.warning(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ {key}: {e}")
        # –£–¥–∞–ª—è–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π –∫—ç—à
        if os.path.exists(cache_path):
            os.remove(cache_path)
        return None


def save_cache(key: str, data: Dict[str, Any]) -> None:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏
    
    Args:
        key: –ö–ª—é—á –∫—ç—à–∞
        data: –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    """
    cache_path = get_cache_path(key)
    
    try:
        cache_data = {
            'timestamp': datetime.now().isoformat(),
            'data': data
        }
        
        with open(cache_path, 'w', encoding='utf-8') as f:
            json.dump(cache_data, f, ensure_ascii=False, indent=2)
        
        logger.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω –∫—ç—à –¥–ª—è {key}")
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à–∞ {key}: {e}")


def translate_weather_description(desc: str) -> str:
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
    
    Args:
        desc: –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
    
    Returns:
        –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    """
    desc_lower = desc.lower()
    
    # –ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
    if desc_lower in WEATHER_TRANSLATIONS:
        return WEATHER_TRANSLATIONS[desc_lower]
    
    # –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    for eng, rus in WEATHER_TRANSLATIONS.items():
        if eng in desc_lower or desc_lower in eng:
            return rus
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
    logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è: {desc}")
    return desc


def translate_pollution_status(status: str) -> str:
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–∑–¥—É—Ö–∞ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
    
    Args:
        status: –°—Ç–∞—Ç—É—Å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
    
    Returns:
        –°—Ç–∞—Ç—É—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    """
    return POLLUTION_STATUS_TRANSLATIONS.get(status, status)


def retry_request(func: Callable, *args, max_attempts: int = 3, **kwargs) -> Any:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
    
    Args:
        func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        *args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
        max_attempts: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        **kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    
    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    delays = [1, 2, 4]  # –ü–∞—É–∑—ã –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    
    for attempt in range(1, max_attempts + 1):
        try:
            result = func(*args, **kwargs)
            return result
        except Exception as e:
            if attempt < max_attempts:
                delay = delays[min(attempt - 1, len(delays) - 1)]
                logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt}/{max_attempts} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {delay}—Å")
                time.sleep(delay)
            else:
                logger.error(f"–í—Å–µ {max_attempts} –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å: {e}")
                return None
    
    return None


def format_forecast_day(forecast_items: list, day_name: str = "") -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –¥–µ–Ω—å –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç
    
    Args:
        forecast_items: –°–ø–∏—Å–æ–∫ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –Ω–∞ –¥–µ–Ω—å (–∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞)
        day_name: –ù–∞–∑–≤–∞–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    """
    if not forecast_items:
        return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è"
    
    lines = []
    if day_name:
        lines.append(f"üìÖ {day_name}")
        lines.append("")
    
    for item in forecast_items:
        time_str = item.get('dt_txt', '')
        if time_str:
            # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ "2025-01-15 12:00:00"
            try:
                dt = datetime.strptime(time_str, "%Y-%m-%d %H:%M:%S")
                time_display = dt.strftime("%H:%M")
            except:
                time_display = time_str.split()[1][:5] if len(time_str.split()) > 1 else time_str
        else:
            time_display = "N/A"
        
        temp = item.get('main', {}).get('temp', 'N/A')
        desc = item.get('weather', [{}])[0].get('description', 'N/A')
        desc_ru = translate_weather_description(desc)
        humidity = item.get('main', {}).get('humidity', 'N/A')
        wind = item.get('wind', {}).get('speed', 'N/A')
        
        lines.append(f"üïê {time_display}")
        lines.append(f"   üå°Ô∏è {temp}¬∞C | üíß {humidity}% | üí® {wind} –º/—Å")
        lines.append(f"   {desc_ru.capitalize()}")
        lines.append("")
    
    return "\n".join(lines)


def format_datetime_ru(dt: datetime) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç datetime –≤ —Ä—É—Å—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç (dd.mm.yyyy HH:MM)
    
    Args:
        dt: –û–±—ä–µ–∫—Ç datetime
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    """
    return dt.strftime("%d.%m.%Y %H:%M")


def validate_city_name(city: str) -> bool:
    """
    –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
    
    Args:
        city: –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
    
    Returns:
        True –µ—Å–ª–∏ –≤–∞–ª–∏–¥–Ω–æ, False –∏–Ω–∞—á–µ
    """
    if not city or len(city.strip()) < 2:
        return False
    return True


def validate_coordinates(lat: float, lon: float) -> bool:
    """
    –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    
    Args:
        lat: –®–∏—Ä–æ—Ç–∞
        lon: –î–æ–ª–≥–æ—Ç–∞
    
    Returns:
        True –µ—Å–ª–∏ –≤–∞–ª–∏–¥–Ω–æ, False –∏–Ω–∞—á–µ
    """
    return -90 <= lat <= 90 and -180 <= lon <= 180


def validate_notification_interval(interval: int) -> bool:
    """
    –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    
    Args:
        interval: –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ —á–∞—Å–∞—Ö
    
    Returns:
        True –µ—Å–ª–∏ –≤–∞–ª–∏–¥–Ω–æ (1-24), False –∏–Ω–∞—á–µ
    """
    return 1 <= interval <= 24

